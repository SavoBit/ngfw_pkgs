#!/bin/dash

SHIELD_QUEUE_NUM=3001

if [ -z "${IPTABLES}" ] ; then
    IPTABLES=iptables
fi

local queue_pid=`awk -v queue=${SHIELD_QUEUE_NUM} '{ if ( $1 == queue ) print $2 }' /proc/net/netfilter/nfnetlink_queue`

if [ -z "${queue_pid}" ]; then 
    echo "[`date`] The untangle-shield is not running. Removing queue rules (if present)."

    ${IPTABLES} -t mangle -N queue-to-shield >/dev/null 2>&1
    ${IPTABLES} -t mangle -F queue-to-shield >/dev/null 2>&1
else
    echo "[`date`] The untangle-shield is running. Inserting queue rules."

    ${IPTABLES} -t mangle -N queue-to-shield >/dev/null 2>&1
    ${IPTABLES} -t mangle -F queue-to-shield >/dev/null 2>&1

    ## Queue any TCP 
    ${IPTABLES} -t mangle -A queue-to-shield -p tcp -j NFQUEUE --queue-num ${SHIELD_QUEUE_NUM}

    ## Queue all UDP packets (to unicast)
    ${IPTABLES} -t mangle -A queue-to-shield -p udp -m addrtype --dst-type unicast -j NFQUEUE --queue-num ${SHIELD_QUEUE_NUM}

    # Queue forwarded packets to shield
    # Only queue first packet of each sessio
    # Only queue non-bypassed traffic
    ${IPTABLES} -t mangle -A FORWARD -m conntrack --ctstate NEW -m mark --mark 0/${MASK_BYPASS} -j queue-to-shield
fi


