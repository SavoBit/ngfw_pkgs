#! /bin/bash

/etc/init.d/untangle-vm stop

echo -n "Removing settings and configuration..."

rm -f /usr/share/untangle/conf/wizard-complete-flag
rm -f /usr/share/untangle/conf/wizard.js
rm -rf /usr/share/untangle/settings/*
rm -rf /usr/share/untangle/quarantine
rm -rf /usr/share/untangle/web/reports/data/*
rm -rf /etc/openvpn/*

if [ -f /usr/bin/psql ] ; then
    psql -U postgres -c "DROP SCHEMA reports CASCADE" uvm >/dev/null 2>&1
    psql -U postgres -c "DROP DATABASE IF EXISTS uvm" >/dev/null 2>&1
fi

echo " done"

echo -n "Restoring File System State..."

# restore canonical files
tar -C / -zxf /usr/share/untangle/conf/canonical.tar.gz

# restore logo
cp -f /var/www/images/Logo150x96.png /var/www/images/BrandingLogo.png

# restore OEM settings if they exist
if [ -f /usr/share/untangle/bin/oem-apply.sh ] ; then
    /usr/share/untangle/bin/oem-apply.sh
fi

# rerun all the hardware default scripts
ls /etc/init.d/untangle-hardware-* 2>/dev/null | while read script ; do 
    $script restart
done

echo " done"

exit 0
