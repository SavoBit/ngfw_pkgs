#! /bin/bash

. /etc/default/untangle-vm

/etc/init.d/untangle-vm stop
/etc/init.d/untangle-reports stop

# touch factory-defaults file to tell system to start in wizard mode
touch /usr/share/untangle/conf/factory-defaults

echo "Restoring settings..."

# Drop that UVM database, and exit if it is unable to create it.
psql -U postgres -c "DROP DATABASE IF EXISTS uvm" || exit 1

# Drop all settings
rm -rf /usr/share/untangle/settings/*

createuser -U postgres -dSR untangle 2>/dev/null
createdb -O postgres -U postgres uvm || exit 2

/usr/share/untangle/bin/update-schema settings uvm
/usr/share/untangle/bin/update-schema events uvm
/usr/share/untangle/bin/update-schema settings untangle-node-router
/usr/share/untangle/bin/update-schema events untangle-node-router
psql -X -U postgres uvm &> /dev/null <<EOF
INSERT INTO u_tid VALUES (1);
INSERT INTO u_node_manager_state VALUES (nextval('hibernate_sequence'), 2);
INSERT INTO u_node_persistent_state VALUES (nextval('hibernate_sequence'), 'untangle-node-router', 1, '\\\\001\\\\000', 'running');
INSERT INTO u_node_preferences VALUES (nextval('hibernate_sequence'), 1, 255, 175, 175, 255);
INSERT INTO u_tid VALUES (2);
INSERT INTO u_node_persistent_state VALUES (nextval('hibernate_sequence'), 'untangle-casing-ftp', 2, '\\\\002\\\\000', 'running');
INSERT INTO u_node_preferences VALUES (nextval('hibernate_sequence'), 2, 255, 175, 175, 255);
EOF

echo "Restoring Database settings... done"

# remove files
rm -f /usr/share/untangle/conf/networking.sh
rm -f /usr/share/untangle/conf/uvm.networking.properties
rm -f /usr/share/untangle/conf/timezone
rm -f /usr/share/untangle/conf/keystore
rm -fr /usr/share/untangle/gpg ; mkdir /usr/share/untangle/gpg
rm -fr /usr/share/untangle/conf/registration.info
rm -rf /usr/share/untangle/conf/openvpn
rm -rf /usr/share/untangle/quarantine
rm -rf /etc/openvpn
rm -rf /usr/share/untangle/web/reports/data/*

echo "Restoring Local Directory..."

SLAPD_CONFIG=/etc/untangle-ldap/slapd.conf
SLAPD_LIB_DIR=/var/lib/untangle-ldap
UNTANGLE_SLAPD_CONFIG_DIR=/usr/share/untangle-ldap-server
if [ -f $SLAPD_CONFIG ]; then
    # restore initial LDAP db
    /etc/init.d/untangle-slapd stop &> /dev/null
    rm -rf ${SLAPD_LIB_DIR}
    mkdir -p ${SLAPD_LIB_DIR}
    cp ${UNTANGLE_SLAPD_CONFIG_DIR}/DB_CONFIG ${SLAPD_LIB_DIR}/DB_CONFIG
    slapadd -f $SLAPD_CONFIG -l ${UNTANGLE_SLAPD_CONFIG_DIR}/initial.ldif
    slapindex -f $SLAPD_CONFIG &> /dev/null #ignore error (debian bug #432662)
    /etc/init.d/untangle-slapd start &> /dev/null
fi

echo "Restoring Local Directory... done"

echo "Restoring Network Settings..."

## Backup the current networking settings
# [ -x  /usr/share/untangle-net-alpaca/scripts/backup ] && /usr/share/untangle-net-alpaca/scripts/backup /usr/share/untangle/conf/alpaca-backup.uab "Return to Factory Defaults."

## Stop the network manager
/etc/init.d/untangle-net-alpaca stop &> /dev/null

## Remove the database file (an empty file is also in canonical just in case)
rm -f /var/lib/rails/untangle-net-alpaca/database/production.db

# ## Start the network manager
# /etc/init.d/untangle-net-alpaca start &> /dev/null
#
#echo "Restoring Network Settings... done"

echo -n "Restoring File System State..."

# restore canonical files
tar -C / -zxf /usr/share/untangle/conf/canonical.tar.gz

# restore logo
cp -f /var/www/images/Logo150x96.gif /var/www/images/BrandingLogo.gif

# restore OEM settings if they exist
if [ -f /usr/share/untangle/bin/oem-apply.sh ] ; then
    /usr/share/untangle/bin/oem-apply.sh
fi

echo " done"

exit 0
