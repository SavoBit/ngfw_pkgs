#!/bin/dash

## This doesn't actually do anything.
CPD_HOME=${CPD_HOME:-""}

awk_script()
{
    cat <<'EOF'
/^Name:/ { ipset_name="" }
## Only search for ip_sets that are in the correct ipset.
/^Name: cpd-ipv4-authenticated/ { ipset_name=$2 ; num_members=0 }

## By default do not count members.
/^Bindings:/ { 
  count_member="false"
}

## Print all of the items that are in between Members and Bindings
{ if ( count_member == "true" ) print }

/^Members:/ { if ( ipset_name != "" ) count_member="true" }
EOF
}

## Get from the databse the entries that should be in the ipset.  Each
## line should be in the form 1.2.3.4:00:11:22:33:44:55 or if there is
## no MAC Address, 1.2.3.4
get_host_entries()
{
    psql -U postgres uvm -t -c "SELECT ipv4_addr,hw_addr FROM events.n_adconnector_host_database_entry ORDER BY ipv4_addr" | sed -e 's| ||g' -e 's/|$//' -e 's/|/:/' -e '/^$/ d' | uniq
}

## Get the actual entries from the IPSet
get_ipset_entries()
{
    ipset -nL | awk "`awk_script`" | sort
}

fix_entries_script()
{
    cat <<'EOF'
BEGIN { added_ipv4=0 ; added_hw_addr=0 ; deleted_ipv4=0 ; deleted_hw_addr=0 }
/^> *[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/ {
  ipv4_addr=$2
  system( "ipset -A cpd-ipv4-authenticated " ipv4_addr )
  system( "ipset -D cpd-ipv4-expired " ipv4_addr )
  added_ipv4++
  next
}
/^> *[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+:[0-9]+:[0-9]+:[0-9]+:[0-9]+:[0-9]+$/ { 
  print( "ADDING HW ADDR IS NOT SUPPORTED." )
  next
}
/^< *[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/ { 
  ipv4_addr=$2
  system( "ipset -A cpd-ipv4-expired " ipv4_addr )
  system( "ipset -D cpd-ipv4-authenticated " ipv4_addr )
  deleted_ipv4++
  next
}
/^< *[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+:[0-9]+:[0-9]+:[0-9]+:[0-9]+:[0-9]+$/ { 
  print( "REMOVING HW ADDR IS NOT SUPPORTED." )
  next
}
END { print current_time ": Added " added_ipv4 "," added_hw_addr " Deleted " deleted_ipv4 "," deleted_hw_addr }
EOF
}

## Hash sure this exists.
ipset -N cpd-ipv4-authenticated iphash > /dev/null 2>&1 || true
ipset -N cpd-ipv4-expired iphash > /dev/null 2>&1 || true

ipset_entries=`mktemp`
host_entries=`mktemp`

get_ipset_entries > ${ipset_entries}

get_host_entries > ${host_entries}

diff ${ipset_entries} ${host_entries} | awk -v current_time="`date`" "`fix_entries_script`"

rm -f ${ipset_entries}
rm -f ${host_entries}
