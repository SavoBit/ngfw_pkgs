#! /bin/sh

chown -R rbot /home/rbot
mkdir -p /home/rbot/.ssh
chmod 700 /home/rbot/.ssh

RBOT_CONF_FILE=/home/rbot/.rbot/conf.yaml
ACTIVATION_KEY_FILE=/usr/share/metavize/activation.key

if [ -f $ACTIVATION_KEY_FILE  ] ; then
  KEY=`sed -e 's/-//' /usr/share/metavize/activation.key`
else
  KEY=`hostname`_1
fi
KEY=${KEY//-}

perl -npe 's/\+NAME\+/r'$KEY'/' $RBOT_CONF_FILE.template >| $RBOT_CONF_FILE

# first test is for the initial upgrade...
if pidof /usr/sbin/sshd > /dev/null || ps aux | grep -q 'ruby /usr/bin/rbot' ; then
  /etc/init.d/rbot-mv stop
  /etc/init.d/rbot-mv start
fi

exit 0