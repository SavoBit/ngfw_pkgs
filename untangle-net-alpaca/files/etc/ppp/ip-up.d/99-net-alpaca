#! /bin/dash

# These variables are for the use of the scripts run by run-parts
# PPP_IFACE="$1"
# PPP_TTY="$2"
# PPP_SPEED="$3"
# PPP_LOCAL="$4"
# PPP_REMOTE="$5"
# PPP_IPPARAM="$6"

mkdir -p /var/log/untangle-net-alpaca/

exec >> /var/log/untangle-net-alpaca/pppoe.log 2>&1

ADD_UPLINK_SCRIPT="/usr/share/untangle-net-alpaca/scripts/add-uplink"

## This is borrowed from etc/dhcp3/dhclient-enter-hooks.d/net-alpaca.
make_resolv_conf() { 
    ## This guarantees that ${t_new_domain_name_servers} will just be " "
    local t_new_domain_name_servers="`echo "${DNS1}\n${DNS2}" | sort | uniq`"
    
    ## Check MS_DNSx if the DNS servers were not specified in DNS1 and DNS2
    test -z "${t_new_domain_name_servers}" && {
        t_new_domain_name_servers=`echo "${MS_DNS1}\n${MS_DNS2}" | sort | uniq`
    }

    ## only update the dns server when instructed to.
    if [ -n "${t_new_domain_name_servers}" ] && [ "${USEPEERDNS}x" = "1x" ]; then
        local t_hash="`md5sum /etc/dnsmasq.conf`"
        ## if [ -n "$new_domain_name" ]; then
            ## echo search $new_domain_name >>$new_resolv_conf
        ## fi
        
        if [ -n "$t_new_domain_name_servers" ]; then
            for nameserver in $t_new_domain_name_servers ; do
                /bin/echo -e "#new_name_server=${nameserver} # uplink.${PPPOE_UPLINK_INDEX}" >> /etc/dnsmasq.conf
            done
            
            sed -i -e "/^#*\s*server=.*uplink.${PPPOE_UPLINK_INDEX}/d" -e 's/^#new_name_server=/server=/' /etc/dnsmasq.conf
        fi

        local t_new_hash="`md5sum /etc/dnsmasq.conf`"
                    
        ## Reststart DNS MASQ if necessary
        if [ "${t_hash}x" != "${t_new_hash}x" ]; then
            /bin/echo -e "[DEBUG: `date`] Restarting dnsmasq"
            /etc/init.d/dnsmasq restart
        else
            /bin/echo -e "[DEBUG: `date`] ignore dnsmasq restart"
        fi
    fi

    ## Fix resolv.conf which has inevitably been overwritten by another script.
    local t_suffix
    
    if [ -f /etc/dnsmasq.conf ]; then
        t_suffix=`awk '/^domain=/ { sub( "domain=", "" ) ; print }' /etc/dnsmasq.conf`
    fi
    
    t_suffix=${t_suffix:-"example.com"}

    cat <<EOF > /etc/resolv.conf
## `date`
## Auto Generated by the Untangle Net Alpaca
## If you modify this file manually, your changes
## may be overriden

## dns-masq handles all of the name resolution
nameserver 127.0.0.1
search ${t_suffix}
EOF

    return 0
}

INTERFACE_PROPERTIES=/etc/untangle-net-alpaca/interface.properties
CONNECTION_FILE=`cat /var/run/${PPP_IFACE}.pid`
CONNECTION_FILE=`cat "/proc/${CONNECTION_FILE}/cmdline" | tr '\000' '\001' | awk -v RS='\001' '/^connection./ { print ; exit }'`

if [ -n "${CONNECTION_FILE}" ] && [ -f "/etc/ppp/peers/${CONNECTION_FILE}" ]; then
    PPPOE_UPLINK_INDEX=`awk '/# *PPPOE_UPLINK_INDEX=/ { sub( "# *PPPOE_UPLINK_INDEX=", "" ); print ; exit }' \
        "/etc/ppp/peers/${CONNECTION_FILE}"`

    FOUND_INDEX=true
fi

if [ -z "${PPPOE_UPLINK_INDEX}" ]; then
    PPPOE_UPLINK_INDEX=1
fi

make_resolv_conf

[ -x "${ADD_UPLINK_SCRIPT}" ] && {
    ${ADD_UPLINK_SCRIPT} ${PPP_IFACE} ppp "uplink.${PPPOE_UPLINK_INDEX}"
}

run-parts /etc/untangle-net-alpaca/scripts/update-address.d

true
