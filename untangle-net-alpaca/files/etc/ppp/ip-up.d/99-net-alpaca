#! /bin/dash

# These variables are for the use of the scripts run by run-parts
# PPP_IFACE="$1"
# PPP_TTY="$2"
# PPP_SPEED="$3"
# PPP_LOCAL="$4"
# PPP_REMOTE="$5"
# PPP_IPPARAM="$6"

mkdir -p /var/log/untangle-net-alpaca/

exec >> /var/log/untangle-net-alpaca/pppoe.log 2>&1

## This is borrowed from etc/dhcp3/dhclient-enter-hooks.d/net-alpaca.
make_resolv_conf() { 
    local t_new_domain_name_servers
    ## This guarantees that ${t_new_domain_name_servers} will just be " "
    test -n "${DNS1}" && t_new_domain_name_servers="${DNS_1}"
    test -n "${DNS2}" && t_new_domain_name_servers="${t_new_domain_name_servers} ${DNS_2}"
        
    ## only update the dns server when instructed to.
    if [ -n "$t_new_domain_name_servers" -a "${USEPEERDNS}x" == "1x" ]; then
        local t_hash=`md5sum /etc/dnsmasq.conf`
        
        if [ -n "$t_new_domain_name_servers" ]; then
            for nameserver in $t_new_domain_name_servers ; do
                /bin/echo -e "#new_name_server=${nameserver}" >> /etc/dnsmasq.conf
            done

            sed -i -e '/^server=/d' -e 's/^#new_name_server=/server=/' /etc/dnsmasq.conf
        fi

        local t_new_hash=`md5sum /etc/dnsmasq.conf`
                    
        ## Reststart DNS MASQ if necessary
        if [ "${t_hash}x" != "${t_new_hash}x" ]; then
            /bin/echo -e "[DEBUG: `date`] Restarting dnsmasq"
            /etc/init.d/dnsmasq restart
        else
            /bin/echo -e "[DEBUG: `date`] ignore dnsmasq restart"
        fi
    fi

    ## Fix resolv.conf which has inevitably been overwritten by another script.
    local t_suffix
    
    if [ -f /etc/dnsmasq.conf ]; then
        t_suffix=`awk '/^domain-suffix=/ { sub( "domain-suffix=", "" ) ; print }' /etc/dnsmasq.conf`
    fi
    
    t_suffix=${t_suffix:-"example.com"}

    cat <<EOF > /etc/resolv.conf
## `date`
## Auto Generated by the Untangle Net Alpaca
## If you modify this file manually, your changes
## may be overriden

## dns-masq handles all of the name resolution
nameserver 127.0.0.1
search ${t_suffix}
EOF

    return 0
}

make_resolv_conf

run-parts /etc/untangle-net-alpaca/scripts/update-address.d

true
