#!/bin/dash

## This script the settings from the current running system configuration on the box.

BACKUP_DIR=/var/backup/untangle-net-alpaca
BACKUP_SCRIPT=/usr/share/untangle-net-alpaca/scripts/backup

BASE_DIR=/var/lib/rails/untangle-net-alpaca/

## rails environment, defaults to production
MONGREL_ENV="production"

trap "restartAlpaca" EXIT

## For logging just in case the file doesn't exist.
mkdir -p /var/log/untangle-net-alpaca

restartAlpaca()
{   
    /etc/init.d/untangle-net-alpaca restart
}

backupSettings()
{   
    local t_name=$1
    mkdir -p ${BACKUP_DIR}
    if [ -x "${BACKUP_SCRIPT}" ]; then
        ${BACKUP_SCRIPT} ${BACKUP_DIR}/${t_name}-`date +"%y%m%d%H%M"`.uab "Upgrade Backup"
    else
        echo "${BACKUP_SCRIPT} doesn't exist"
    fi
}

backupSettings "pre-upgrade"

## Write a minimum /etc/network/interfaces, just in case the rake task doesn't detect any interfaces.
if [ ! -f /etc/network/interfaces ]; then
    cat <<EOF > /etc/network/interfaces
## `date`
## Auto Generated by the Untangle Net Alpaca
## If you modify this file manually, your changes
## may be overriden

auto cleanup
iface cleanup inet manual

## Configuration for the loopback interface
auto lo
iface lo inet loopback

EOF
fi

## Stop the alpaca
/etc/init.d/untangle-net-alpaca stop

## Delete all of the databases
rm -f ${BASE_DIR}/database/*.db

## Change into the directory and convert the settings
cd ${BASE_DIR} && {
    rake alpaca:load_configuration RAILS_ENV=${MONGREL_ENV} || echo "Unable to load the network settings from the box."
} || {
    echo "Unable to change into the alpaca directory (${BASE_DIR})"
}

## Backup the settings again
backupSettings "post-upgrade"

