diff -urN build-tree.orig/apache2/Makefile.in build-tree/apache2/Makefile.in
--- build-tree.orig/apache2/Makefile.in	2004-11-24 12:31:09.000000000 -0700
+++ build-tree/apache2/Makefile.in	2005-02-09 11:27:22.000000000 -0700
@@ -179,7 +179,6 @@
 	@cp -p $(srcdir)/modules/http/mod_core.h $(DESTDIR)$(includedir)
 	@cp -p $(srcdir)/modules/proxy/mod_proxy.h $(DESTDIR)$(includedir)
 	@cp -p $(srcdir)/modules/ssl/*.h $(DESTDIR)$(includedir)
-	@cp -p $(srcdir)/srclib/pcre/pcre*.h $(DESTDIR)$(includedir)
 	@cp -p $(srcdir)/os/$(OS_DIR)/*.h $(DESTDIR)$(includedir)
 	@chmod 644 $(DESTDIR)$(includedir)/*.h
 
diff -urN build-tree.orig/apache2/configure.in build-tree/apache2/configure.in
--- build-tree.orig/apache2/configure.in	2004-11-24 12:31:09.000000000 -0700
+++ build-tree/apache2/configure.in	2005-02-09 11:25:13.000000000 -0700
@@ -476,6 +476,7 @@
 
 dnl AP_LIBS specifies the actual libraries. note we have some required libs.
 AP_LIBS="$abs_builddir/srclib/pcre/libpcre.la $AP_LIBS"
+APR_ADDTO(CPPFLAGS, [-I$abs_builddir/srclib/pcre])
 
 dnl APR should go after the other libs, so the right symbols can be picked up
 AP_LIBS="$AP_LIBS `$apu_config --link-libtool --libs` `$apr_config --link-libtool --libs`"
diff -urN build-tree.orig/apache2/include/ap_regex.h build-tree/apache2/include/ap_regex.h
--- build-tree.orig/apache2/include/ap_regex.h	1969-12-31 17:00:00.000000000 -0700
+++ build-tree/apache2/include/ap_regex.h	2005-02-09 11:28:02.000000000 -0700
@@ -0,0 +1,117 @@
+/*************************************************
+*       Perl-Compatible Regular Expressions      *
+*************************************************/
+
+/* Copyright (c) 1997-2000 University of Cambridge */
+
+/**
+ * @file include/pcreposix.h
+ * @brief PCRE definitions
+ */
+
+#ifndef _AP_PCREPOSIX_H
+#define _AP_PCREPOSIX_H
+
+/* This is the header for the POSIX wrapper interface to the PCRE Perl-
+Compatible Regular Expression library. It defines the things POSIX says should
+be there. I hope. */
+
+/* Have to include stdlib.h in order to ensure that size_t is defined. */
+
+#include <stdlib.h>
+
+/* Allow for C++ users */
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+/* Options defined by POSIX. */
+
+  /** Ignore case */
+#define AP_REG_ICASE     0x01
+  /** Don't match newlines with wildcards */
+#define AP_REG_NEWLINE   0x02
+  /** Don't match BOL */
+#define AP_REG_NOTBOL    0x04
+  /** Don't match EOL */
+#define AP_REG_NOTEOL    0x08
+
+/* These are not used by PCRE, but by defining them we make it easier
+to slot PCRE into existing programs that make POSIX calls. */
+
+  /** UNUSED! */
+#define AP_REG_EXTENDED  0
+  /** UNUSED! */
+#define AP_REG_NOSUB     0
+
+/* Error values. Not all these are relevant or used by the wrapper. */
+
+enum {
+  AP_REG_ASSERT = 1,  /* internal error ? */
+  AP_REG_ESPACE,      /* failed to get memory */
+  AP_REG_INVARG,      /* bad argument */
+  AP_REG_NOMATCH      /* match failed */
+};
+
+
+/* The structure representing a compiled regular expression. */
+
+typedef struct {
+  void *re_pcre;
+  size_t re_nsub;
+  size_t re_erroffset;
+} ap_regex_t;
+
+/* The structure in which a captured offset is returned. */
+
+typedef int ap_regoff_t;
+
+typedef struct {
+  ap_regoff_t rm_so;
+  ap_regoff_t rm_eo;
+} ap_regmatch_t;
+
+#ifndef AP_DECLARE
+#define AP_DECLARE(x) x
+#endif /* AP_DECLARE */
+
+/* The functions */
+
+AP_DECLARE(int) ap_regcomp(ap_regex_t *, const char *, int);
+
+/**
+ * Match a null-terminated string against a pre-compiled regex.
+ * @param preg The pre-compiled regex
+ * @param string The string to match
+ * @param nmatch Provide information regarding the location of any matches
+ * @param pmatch Provide information regarding the location of any matches
+ * @param eflags Bitwise or of any of:
+ *   @li #REG_NOTBOL - match-beginning-of-line operator always
+ *     fails to match
+ *   @li #REG_NOTEOL - match-end-of-line operator always fails to match
+ * @return 0 for successful match, #REG_NOMATCH otherwise
+ */ 
+AP_DECLARE(int) ap_regexec(const ap_regex_t *preg, const char *string,
+		                           size_t nmatch, ap_regmatch_t *pmatch, int eflags);
+
+/**
+ * Return the error code returned by regcomp or regexec into error messages
+ * @param errcode the error code returned by regexec or regcomp
+ * @param preg The precompiled regex
+ * @param errbuf A buffer to store the error in
+ * @param errbuf_size The size of the buffer
+ */
+AP_DECLARE(size_t) ap_regerror(int errcode, const ap_regex_t *preg, 
+		                               char *errbuf, size_t errbuf_size);
+
+/** Destroy a pre-compiled regex.
+ * @param preg The pre-compiled regex to free.
+ */
+AP_DECLARE(void) ap_regfree(ap_regex_t *preg);
+
+#ifdef __cplusplus
+}   /* extern "C" */
+#endif
+
+#endif /* End of pcreposix.h */
diff -urN build-tree.orig/apache2/include/http_core.h build-tree/apache2/include/http_core.h
--- build-tree.orig/apache2/include/http_core.h	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/include/http_core.h	2005-02-09 11:25:13.000000000 -0700
@@ -490,7 +490,7 @@
     
     /* Access control */
     apr_array_header_t *sec_file;
-    regex_t *r;
+    ap_regex_t *r;
 
     const char *mime_type;       /* forced with ForceType  */
     const char *handler;         /* forced with SetHandler */
diff -urN build-tree.orig/apache2/include/httpd.h build-tree/apache2/include/httpd.h
--- build-tree.orig/apache2/include/httpd.h	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/include/httpd.h	2005-02-09 11:25:13.000000000 -0700
@@ -41,7 +41,7 @@
 
 #include "os.h"
 
-#include "pcreposix.h"
+#include "ap_regex.h"
 
 /* Note: util_uri.h is also included, see below */
 
@@ -1503,7 +1503,7 @@
  *   @li #REG_NEWLINE  - Match-any-character operators don't match new-line
  * @return The compiled regular expression
  */
-AP_DECLARE(regex_t *) ap_pregcomp(apr_pool_t *p, const char *pattern,
+AP_DECLARE(ap_regex_t *) ap_pregcomp(apr_pool_t *p, const char *pattern,
 				   int cflags);
 
 /**
@@ -1511,32 +1511,7 @@
  * @param p The pool the regex was allocated from
  * @param reg The regular expression to free
  */
-AP_DECLARE(void) ap_pregfree(apr_pool_t *p, regex_t *reg);
-
-/**
- * Match a null-terminated string against a pre-compiled regex.
- * @param preg The pre-compiled regex
- * @param string The string to match
- * @param nmatch Provide information regarding the location of any matches
- * @param pmatch Provide information regarding the location of any matches
- * @param eflags Bitwise or of any of:
- *   @li #REG_NOTBOL - match-beginning-of-line operator always
- *     fails to match
- *   @li #REG_NOTEOL - match-end-of-line operator always fails to match
- * @return 0 for successful match, #REG_NOMATCH otherwise
- */ 
-AP_DECLARE(int)    ap_regexec(regex_t *preg, const char *string,
-                              size_t nmatch, regmatch_t pmatch[], int eflags);
-
-/**
- * Return the error code returned by regcomp or regexec into error messages
- * @param errcode the error code returned by regexec or regcomp
- * @param preg The precompiled regex
- * @param errbuf A buffer to store the error in
- * @param errbuf_size The size of the buffer
- */
-AP_DECLARE(size_t) ap_regerror(int errcode, const regex_t *preg, 
-                               char *errbuf, size_t errbuf_size);
+AP_DECLARE(void) ap_pregfree(apr_pool_t *p, ap_regex_t *reg);
 
 /**
  * After performing a successful regex match, you may use this function to 
@@ -1550,7 +1525,7 @@
  * @param pmatch the pmatch array returned from ap_pregex
  */
 AP_DECLARE(char *) ap_pregsub(apr_pool_t *p, const char *input, const char *source,
-                              size_t nmatch, regmatch_t pmatch[]);
+                              size_t nmatch, ap_regmatch_t pmatch[]);
 
 /**
  * We want to downcase the type/subtype for comparison purposes
diff -urN build-tree.orig/apache2/include/pcreposix.h build-tree/apache2/include/pcreposix.h
--- build-tree.orig/apache2/include/pcreposix.h	2004-11-24 12:31:09.000000000 -0700
+++ build-tree/apache2/include/pcreposix.h	1969-12-31 17:00:00.000000000 -0700
@@ -1,99 +0,0 @@
-/*************************************************
-*       Perl-Compatible Regular Expressions      *
-*************************************************/
-
-/* Copyright (c) 1997-2000 University of Cambridge */
-
-/**
- * @file include/pcreposix.h
- * @brief PCRE definitions
- */
-
-#ifndef _PCREPOSIX_H
-#define _PCREPOSIX_H
-
-/* This is the header for the POSIX wrapper interface to the PCRE Perl-
-Compatible Regular Expression library. It defines the things POSIX says should
-be there. I hope. */
-
-/* Have to include stdlib.h in order to ensure that size_t is defined. */
-
-#include <stdlib.h>
-
-/* Allow for C++ users */
-
-#ifdef __cplusplus
-extern "C" {
-#endif
-
-/* Options defined by POSIX. */
-
-  /** Ignore case */
-#define REG_ICASE     0x01
-  /** Don't match newlines with wildcards */
-#define REG_NEWLINE   0x02
-  /** Don't match BOL */
-#define REG_NOTBOL    0x04
-  /** Don't match EOL */
-#define REG_NOTEOL    0x08
-
-/* These are not used by PCRE, but by defining them we make it easier
-to slot PCRE into existing programs that make POSIX calls. */
-
-  /** UNUSED! */
-#define REG_EXTENDED  0
-  /** UNUSED! */
-#define REG_NOSUB     0
-
-/* Error values. Not all these are relevant or used by the wrapper. */
-
-enum {
-  REG_ASSERT = 1,  /* internal error ? */
-  REG_BADBR,       /* invalid repeat counts in {} */
-  REG_BADPAT,      /* pattern error */
-  REG_BADRPT,      /* ? * + invalid */
-  REG_EBRACE,      /* unbalanced {} */
-  REG_EBRACK,      /* unbalanced [] */
-  REG_ECOLLATE,    /* collation error - not relevant */
-  REG_ECTYPE,      /* bad class */
-  REG_EESCAPE,     /* bad escape sequence */
-  REG_EMPTY,       /* empty expression */
-  REG_EPAREN,      /* unbalanced () */
-  REG_ERANGE,      /* bad range inside [] */
-  REG_ESIZE,       /* expression too big */
-  REG_ESPACE,      /* failed to get memory */
-  REG_ESUBREG,     /* bad back reference */
-  REG_INVARG,      /* bad argument */
-  REG_NOMATCH      /* match failed */
-};
-
-
-/* The structure representing a compiled regular expression. */
-
-typedef struct {
-  void *re_pcre;
-  size_t re_nsub;
-  size_t re_erroffset;
-} regex_t;
-
-/* The structure in which a captured offset is returned. */
-
-typedef int regoff_t;
-
-typedef struct {
-  regoff_t rm_so;
-  regoff_t rm_eo;
-} regmatch_t;
-
-/* The functions */
-
-extern int regcomp(regex_t *, const char *, int);
-extern int regexec(regex_t *, const char *, size_t, regmatch_t *, int);
-extern size_t regerror(int, const regex_t *, char *, size_t);
-extern void regfree(regex_t *);
-
-#ifdef __cplusplus
-}   /* extern "C" */
-#endif
-
-#endif /* End of pcreposix.h */
diff -urN build-tree.orig/apache2/modules/filters/mod_include.c build-tree/apache2/modules/filters/mod_include.c
--- build-tree.orig/apache2/modules/filters/mod_include.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/filters/mod_include.c	2005-02-09 11:25:13.000000000 -0700
@@ -1173,11 +1173,11 @@
 static int re_check(request_rec *r, include_ctx_t *ctx, 
                     char *string, char *rexp)
 {
-    regex_t *compiled;
-    const apr_size_t nres = sizeof(*ctx->re_result) / sizeof(regmatch_t);
+    ap_regex_t *compiled;
+    const apr_size_t nres = sizeof(*ctx->re_result) / sizeof(ap_regmatch_t);
     int regex_error;
 
-    compiled = ap_pregcomp(r->pool, rexp, REG_EXTENDED | REG_NOSUB);
+    compiled = ap_pregcomp(r->pool, rexp, AP_REG_EXTENDED | AP_REG_NOSUB);
     if (compiled == NULL) {
         ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, r,
                       "unable to compile pattern \"%s\"", rexp);
diff -urN build-tree.orig/apache2/modules/filters/mod_include.h build-tree/apache2/modules/filters/mod_include.h
--- build-tree.orig/apache2/modules/filters/mod_include.h	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/filters/mod_include.h	2005-02-09 11:25:13.000000000 -0700
@@ -140,7 +140,7 @@
     int          start_seq_len;
     char         *end_seq;
     char         *re_string;
-    regmatch_t   (*re_result)[10];
+    ap_regmatch_t   (*re_result)[10];
 } include_ctx_t;
 
 /* These flags are used to set flag bits. */
diff -urN build-tree.orig/apache2/modules/mappers/mod_alias.c build-tree/apache2/modules/mappers/mod_alias.c
--- build-tree.orig/apache2/modules/mappers/mod_alias.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/mappers/mod_alias.c	2005-02-09 11:25:13.000000000 -0700
@@ -40,7 +40,7 @@
     const char *real;
     const char *fake;
     char *handler;
-    regex_t *regexp;
+    ap_regex_t *regexp;
     int redir_status;                /* 301, 302, 303, 410, etc */
 } alias_entry;
 
@@ -112,7 +112,7 @@
     /* XX r can NOT be relative to DocumentRoot here... compat bug. */
 
     if (use_regex) {
-        new->regexp = ap_pregcomp(cmd->pool, f, REG_EXTENDED);
+        new->regexp = ap_pregcomp(cmd->pool, f, AP_REG_EXTENDED);
         if (new->regexp == NULL)
             return "Regular expression could not be compiled.";
         new->real = r;
@@ -176,7 +176,7 @@
     alias_server_conf *serverconf = ap_get_module_config(s->module_config,
                                                          &alias_module);
     int status = (int) (long) cmd->info;
-    regex_t *r = NULL;
+    ap_regex_t *r = NULL;
     const char *f = arg2;
     const char *url = arg3;
 
@@ -196,7 +196,7 @@
     }
 
     if (use_regex) {
-        r = ap_pregcomp(cmd->pool, f, REG_EXTENDED);
+        r = ap_pregcomp(cmd->pool, f, AP_REG_EXTENDED);
         if (r == NULL)
             return "Regular expression could not be compiled.";
     }
@@ -314,7 +314,7 @@
                             int doesc, int *status)
 {
     alias_entry *entries = (alias_entry *) aliases->elts;
-    regmatch_t regm[AP_MAX_REG_MATCH];
+    ap_regmatch_t regm[AP_MAX_REG_MATCH];
     char *found = NULL;
     int i;
 
diff -urN build-tree.orig/apache2/modules/mappers/mod_rewrite.c build-tree/apache2/modules/mappers/mod_rewrite.c
--- build-tree.orig/apache2/modules/mappers/mod_rewrite.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/mappers/mod_rewrite.c	2005-02-09 11:25:13.000000000 -0700
@@ -552,7 +552,7 @@
     char *str = apr_pstrdup(cmd->pool, in_str);
     rewrite_server_conf *sconf;
     rewritecond_entry *newcond;
-    regex_t *regexp;
+    ap_regex_t *regexp;
     char *a1;
     char *a2;
     char *a3;
@@ -602,11 +602,11 @@
        we can compile the pattern for case insensitive matching,
        under the old V8 library we have to do it self via a hack */
     if (newcond->flags & CONDFLAG_NOCASE) {
-        rc = ((regexp = ap_pregcomp(cmd->pool, cp, REG_EXTENDED|REG_ICASE))
+        rc = ((regexp = ap_pregcomp(cmd->pool, cp, AP_REG_EXTENDED|AP_REG_ICASE))
               == NULL);
     }
     else {
-        rc = ((regexp = ap_pregcomp(cmd->pool, cp, REG_EXTENDED)) == NULL);
+        rc = ((regexp = ap_pregcomp(cmd->pool, cp, AP_REG_EXTENDED)) == NULL);
     }
     if (rc) {
         return apr_pstrcat(cmd->pool,
@@ -697,7 +697,7 @@
     char *str = apr_pstrdup(cmd->pool, in_str);
     rewrite_server_conf *sconf;
     rewriterule_entry *newrule;
-    regex_t *regexp;
+    ap_regex_t *regexp;
     char *a1;
     char *a2;
     char *a3;
@@ -743,9 +743,9 @@
         newrule->flags |= RULEFLAG_NOTMATCH;
         cp++;
     }
-    mode = REG_EXTENDED;
+    mode = AP_REG_EXTENDED;
     if (newrule->flags & RULEFLAG_NOCASE) {
-        mode |= REG_ICASE;
+        mode |= AP_REG_ICASE;
     }
     if ((regexp = ap_pregcomp(cmd->pool, cp, mode)) == NULL) {
         return apr_pstrcat(cmd->pool,
@@ -1945,8 +1945,8 @@
     char *output;
     const char *vary;
     char newuri[MAX_STRING_LEN];
-    regex_t *regexp;
-    regmatch_t regmatch[AP_MAX_REG_MATCH];
+    ap_regex_t *regexp;
+    ap_regmatch_t regmatch[AP_MAX_REG_MATCH];
     backrefinfo *briRR = NULL;
     backrefinfo *briRC = NULL;
     int failed;
@@ -2303,7 +2303,7 @@
     char input[MAX_STRING_LEN];
     apr_finfo_t sb;
     request_rec *rsub;
-    regmatch_t regmatch[AP_MAX_REG_MATCH];
+    ap_regmatch_t regmatch[AP_MAX_REG_MATCH];
     int rc;
 
     /*
diff -urN build-tree.orig/apache2/modules/mappers/mod_rewrite.h build-tree/apache2/modules/mappers/mod_rewrite.h
--- build-tree.orig/apache2/modules/mappers/mod_rewrite.h	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/mappers/mod_rewrite.h	2005-02-09 11:25:13.000000000 -0700
@@ -199,14 +199,14 @@
 typedef struct {
     char    *input;                /* Input string of RewriteCond */
     char    *pattern;              /* the RegExp pattern string */
-    regex_t *regexp;
+    ap_regex_t *regexp;
     int      flags;                /* Flags which control the match */
 } rewritecond_entry;
 
 typedef struct {
     apr_array_header_t *rewriteconds;    /* the corresponding RewriteCond entries */
     char    *pattern;              /* the RegExp pattern string */
-    regex_t *regexp;               /* the RegExp pattern compilation */
+    ap_regex_t *regexp;               /* the RegExp pattern compilation */
     char    *output;               /* the Substitution string */
     int      flags;                /* Flags which control the substitution */
     char    *forced_mimetype;      /* forced MIME type of substitution */
@@ -290,7 +290,7 @@
 typedef struct backrefinfo {
     char *source;
     int nsub;
-    regmatch_t regmatch[AP_MAX_REG_MATCH];
+    ap_regmatch_t regmatch[AP_MAX_REG_MATCH];
 } backrefinfo;
 
 
diff -urN build-tree.orig/apache2/modules/metadata/mod_headers.c build-tree/apache2/modules/metadata/mod_headers.c
--- build-tree.orig/apache2/modules/metadata/mod_headers.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/metadata/mod_headers.c	2005-02-09 11:25:13.000000000 -0700
@@ -113,7 +113,7 @@
     hdr_actions action;
     char *header;
     apr_array_header_t *ta;   /* Array of format_tag structs */
-    regex_t *regex;
+    ap_regex_t *regex;
     const char *condition_var;
 } header_entry;
 
@@ -344,13 +344,13 @@
             return "header unset takes two arguments";
     }
     else if (new->action == hdr_echo) {
-        regex_t *regex;
+        ap_regex_t *regex;
         if (value)
             return "Header echo takes two arguments";
         else if (cmd->info == &hdr_in)
             return "Header echo only valid on Header directive";
         else {
-            regex = ap_pregcomp(cmd->pool, hdr, REG_EXTENDED | REG_NOSUB);
+            regex = ap_pregcomp(cmd->pool, hdr, AP_REG_EXTENDED | AP_REG_NOSUB);
             if (regex == NULL) {
                 return "Header echo regex could not be compiled";
             }
diff -urN build-tree.orig/apache2/modules/metadata/mod_setenvif.c build-tree/apache2/modules/metadata/mod_setenvif.c
--- build-tree.orig/apache2/modules/metadata/mod_setenvif.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/metadata/mod_setenvif.c	2005-02-09 11:25:13.000000000 -0700
@@ -106,9 +106,9 @@
 };
 typedef struct {
     char *name;                 /* header name */
-    regex_t *pnamereg;          /* compiled header name regex */
+    ap_regex_t *pnamereg;          /* compiled header name regex */
     char *regex;                /* regex to match against */
-    regex_t *preg;              /* compiled regex */
+    ap_regex_t *preg;              /* compiled regex */
     const apr_strmatch_pattern *pattern; /* non-regex pattern to match */
     apr_table_t *features;      /* env vars to set (or unset) */
     enum special special_type;  /* is it a "special" header ? */
@@ -159,7 +159,7 @@
 }
 
 /*
- * any non-NULL magic constant will do... used to indicate if REG_ICASE should
+ * any non-NULL magic constant will do... used to indicate if AP_REG_ICASE should
  * be used
  */
 #define ICASE_MAGIC	((void *)(&setenvif_module))
@@ -171,8 +171,8 @@
      *    -,_,[A-Z\, [a-z] and [0-9].
      * assume the header name is a regular expression.
      */
-    regex_t *preg = ap_pregcomp(p, "^[-A-Za-z0-9_]*$",
-                                (REG_EXTENDED | REG_NOSUB ));
+    ap_regex_t *preg = ap_pregcomp(p, "^[-A-Za-z0-9_]*$",
+                                (AP_REG_EXTENDED | AP_REG_NOSUB ));
     ap_assert(preg != NULL);
 
     if (ap_regexec(preg, name, 0, NULL, 0)) {
@@ -318,7 +318,7 @@
         }
         else {
             new->preg = ap_pregcomp(cmd->pool, regex,
-                                    (REG_EXTENDED | (icase ? REG_ICASE : 0)));
+                                    (AP_REG_EXTENDED | (icase ? AP_REG_ICASE : 0)));
             if (new->preg == NULL) {
                 return apr_pstrcat(cmd->pool, cmd->cmd->name,
                                    " regex could not be compiled.", NULL);
@@ -354,8 +354,8 @@
              */
             if (is_header_regex(cmd->pool, fname)) {
                 new->pnamereg = ap_pregcomp(cmd->pool, fname,
-                                            (REG_EXTENDED | REG_NOSUB
-                                             | (icase ? REG_ICASE : 0)));
+                                            (AP_REG_EXTENDED | AP_REG_NOSUB
+                                             | (icase ? AP_REG_ICASE : 0)));
                 if (new->pnamereg == NULL)
                     return apr_pstrcat(cmd->pool, cmd->cmd->name,
                                        "Header name regex could not be "
@@ -453,7 +453,7 @@
     apr_size_t val_len = 0;
     int i, j;
     char *last_name;
-    regmatch_t regm[AP_MAX_REG_MATCH];
+    ap_regmatch_t regm[AP_MAX_REG_MATCH];
 
     if (!ap_get_module_config(r->request_config, &setenvif_module)) {
         ap_set_module_config(r->request_config, &setenvif_module,
diff -urN build-tree.orig/apache2/modules/metadata/mod_usertrack.c build-tree/apache2/modules/metadata/mod_usertrack.c
--- build-tree.orig/apache2/modules/metadata/mod_usertrack.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/metadata/mod_usertrack.c	2005-02-09 11:25:13.000000000 -0700
@@ -84,7 +84,7 @@
     char *cookie_name;
     char *cookie_domain;
     char *regexp_string;  /* used to compile regexp; save for debugging */
-    regex_t *regexp;  /* used to find usertrack cookie in cookie header */
+    ap_regex_t *regexp;  /* used to find usertrack cookie in cookie header */
 } cookie_dir_rec;
 
 /* Make Cookie: Now we have to generate something that is going to be
@@ -201,7 +201,7 @@
                                       cookie_name,
                                       "=([^;]+)", NULL);
 
-    dcfg->regexp = ap_pregcomp(p, dcfg->regexp_string, REG_EXTENDED);
+    dcfg->regexp = ap_pregcomp(p, dcfg->regexp_string, AP_REG_EXTENDED);
     ap_assert(dcfg->regexp != NULL);
 }
 
@@ -210,7 +210,7 @@
     cookie_dir_rec *dcfg = ap_get_module_config(r->per_dir_config,
 						&usertrack_module);
     const char *cookie_header;
-    regmatch_t regm[NUM_SUBS];
+    ap_regmatch_t regm[NUM_SUBS];
 
     /* Do not run in subrequests */
     if (!dcfg->enabled || r->main) {
diff -urN build-tree.orig/apache2/modules/proxy/mod_proxy.c build-tree/apache2/modules/proxy/mod_proxy.c
--- build-tree.orig/apache2/modules/proxy/mod_proxy.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/proxy/mod_proxy.c	2005-02-09 11:25:13.000000000 -0700
@@ -524,7 +524,7 @@
     struct proxy_remote *new;
     char *p, *q;
     char *r, *f, *scheme;
-    regex_t *reg = NULL;
+    ap_regex_t *reg = NULL;
     int port;
 
     r = apr_pstrdup(cmd->pool, r1);
@@ -554,7 +554,7 @@
         port = -1;
     *p = '\0';
     if (regex) {
-        reg = ap_pregcomp(cmd->pool, f, REG_EXTENDED);
+        reg = ap_pregcomp(cmd->pool, f, AP_REG_EXTENDED);
         if (!reg)
             return "Regular expression for ProxyRemoteMatch could not be compiled.";
     }
@@ -912,7 +912,7 @@
     char *old_path = cmd->path;
     proxy_dir_conf *conf;
     ap_conf_vector_t *new_dir_conf = ap_create_per_dir_config(cmd->pool);
-    regex_t *r = NULL;
+    ap_regex_t *r = NULL;
     const command_rec *thiscmd = cmd->cmd;
 
     const char *err = ap_check_cmd_context(cmd,
@@ -946,7 +946,7 @@
      * scheme?  See proxy_fixup()
      */
     if (thiscmd->cmd_data) { /* <ProxyMatch> */
-        r = ap_pregcomp(cmd->pool, cmd->path, REG_EXTENDED);
+        r = ap_pregcomp(cmd->pool, cmd->path, AP_REG_EXTENDED);
         if (!r) {
             return "Regex could not be compiled";
         }
@@ -957,7 +957,7 @@
             return "<Proxy ~ > block must specify a path";
         if (strncasecmp(cmd->path, "proxy:", 6))
             cmd->path += 6;
-        r = ap_pregcomp(cmd->pool, cmd->path, REG_EXTENDED);
+        r = ap_pregcomp(cmd->pool, cmd->path, AP_REG_EXTENDED);
         if (!r) {
             return "Regex could not be compiled";
         }
diff -urN build-tree.orig/apache2/modules/proxy/mod_proxy.h build-tree/apache2/modules/proxy/mod_proxy.h
--- build-tree.orig/apache2/modules/proxy/mod_proxy.h	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/proxy/mod_proxy.h	2005-02-09 11:25:13.000000000 -0700
@@ -94,7 +94,7 @@
     const char *protocol;	/* the scheme used to talk to this proxy */
     const char *hostname;	/* the hostname of this proxy */
     apr_port_t  port;		/* the port for this proxy */
-    regex_t *regexp;		/* compiled regex (if any) for the remote */
+    ap_regex_t *regexp;		/* compiled regex (if any) for the remote */
     int use_regex;		/* simple boolean. True if we have a regex pattern */
 };
 
@@ -165,7 +165,7 @@
 typedef struct {
     const char *p;            /* The path */
     int         p_is_fnmatch; /* Is this path an fnmatch candidate? */
-    regex_t    *r;            /* Is this a regex? */
+    ap_regex_t    *r;            /* Is this a regex? */
 } proxy_dir_conf;
 
 typedef struct {
diff -urN build-tree.orig/apache2/modules/proxy/proxy_ftp.c build-tree/apache2/modules/proxy/proxy_ftp.c
--- build-tree.orig/apache2/modules/proxy/proxy_ftp.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/proxy/proxy_ftp.c	2005-02-09 11:25:13.000000000 -0700
@@ -426,11 +426,11 @@
         int found = 0;
         int eos = 0;
 
-        regex_t *re = NULL;
-        regmatch_t re_result[LS_REG_MATCH];
+        ap_regex_t *re = NULL;
+        ap_regmatch_t re_result[LS_REG_MATCH];
 
         /* Compile the output format of "ls -s1" as a fallback for non-unix ftp listings */
-        re = ap_pregcomp(p, LS_REG_PATTERN, REG_EXTENDED);
+        re = ap_pregcomp(p, LS_REG_PATTERN, AP_REG_EXTENDED);
         ap_assert(re != NULL);
 
         /* get a complete line */
diff -urN build-tree.orig/apache2/modules/ssl/ssl_expr_eval.c build-tree/apache2/modules/ssl/ssl_expr_eval.c
--- build-tree.orig/apache2/modules/ssl/ssl_expr_eval.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/modules/ssl/ssl_expr_eval.c	2005-02-09 11:25:13.000000000 -0700
@@ -126,24 +126,24 @@
             ssl_expr *e1;
             ssl_expr *e2;
             char *word;
-            regex_t *regex;
+            ap_regex_t *regex;
 
             e1 = (ssl_expr *)node->node_arg1;
             e2 = (ssl_expr *)node->node_arg2;
             word = ssl_expr_eval_word(r, e1);
-            regex = (regex_t *)(e2->node_arg1);
+            regex = (ap_regex_t *)(e2->node_arg1);
             return (ap_regexec(regex, word, 0, NULL, 0) == 0);
         }
         case op_NRE: {
             ssl_expr *e1;
             ssl_expr *e2;
             char *word;
-            regex_t *regex;
+            ap_regex_t *regex;
 
             e1 = (ssl_expr *)node->node_arg1;
             e2 = (ssl_expr *)node->node_arg2;
             word = ssl_expr_eval_word(r, e1);
-            regex = (regex_t *)(e2->node_arg1);
+            regex = (ap_regex_t *)(e2->node_arg1);
             return !(ap_regexec(regex, word, 0, NULL, 0) == 0);
         }
         default: {
diff -urN build-tree.orig/apache2/modules/ssl/ssl_expr_parse.c build-tree/apache2/modules/ssl/ssl_expr_parse.c
--- build-tree.orig/apache2/modules/ssl/ssl_expr_parse.c	2005-02-07 10:23:43.000000000 -0700
+++ build-tree/apache2/modules/ssl/ssl_expr_parse.c	2005-02-09 11:25:13.000000000 -0700
@@ -818,9 +818,9 @@
 case 24:
 #line 148 "ssl_expr_parse.y"
 { 
-                regex_t *regex;
+                ap_regex_t *regex;
                 if ((regex = ap_pregcomp(ssl_expr_info.pool, ssl_expr_yyvsp[0].cpVal, 
-                                         REG_EXTENDED|REG_NOSUB)) == NULL) {
+                                         AP_REG_EXTENDED|AP_REG_NOSUB)) == NULL) {
                     ssl_expr_error = "Failed to compile regular expression";
                     YYERROR;
                     regex = NULL;
@@ -831,9 +831,9 @@
 case 25:
 #line 158 "ssl_expr_parse.y"
 {
-                regex_t *regex;
+                ap_regex_t *regex;
                 if ((regex = ap_pregcomp(ssl_expr_info.pool, ssl_expr_yyvsp[0].cpVal, 
-                                         REG_EXTENDED|REG_NOSUB|REG_ICASE)) == NULL) {
+                                         AP_REG_EXTENDED|AP_REG_NOSUB|AP_REG_ICASE)) == NULL) {
                     ssl_expr_error = "Failed to compile regular expression";
                     YYERROR;
                     regex = NULL;
diff -urN build-tree.orig/apache2/modules/ssl/ssl_expr_parse.y build-tree/apache2/modules/ssl/ssl_expr_parse.y
--- build-tree.orig/apache2/modules/ssl/ssl_expr_parse.y	2005-02-07 10:23:36.000000000 -0700
+++ build-tree/apache2/modules/ssl/ssl_expr_parse.y	2005-02-09 11:25:13.000000000 -0700
@@ -112,18 +112,18 @@
           ;
 
 regex     : T_REGEX { 
-                regex_t *regex;
+                ap_regex_t *regex;
                 if ((regex = ap_pregcomp(ssl_expr_info.pool, $1, 
-                                         REG_EXTENDED|REG_NOSUB)) == NULL) {
+                                         AP_REG_EXTENDED|AP_REG_NOSUB)) == NULL) {
                     ssl_expr_error = "Failed to compile regular expression";
                     YYERROR;
                 }
                 $$ = ssl_expr_make(op_Regex, regex, NULL);
             }
           | T_REGEX_I {
-                regex_t *regex;
+                ap_regex_t *regex;
                 if ((regex = ap_pregcomp(ssl_expr_info.pool, $1, 
-                                         REG_EXTENDED|REG_NOSUB|REG_ICASE)) == NULL) {
+                                        AP_REG_EXTENDED|AP_REG_NOSUB|AP_REG_ICASE)) == NULL) {
                     ssl_expr_error = "Failed to compile regular expression";
                     YYERROR;
                 }
diff -urN build-tree.orig/apache2/server/Makefile.in build-tree/apache2/server/Makefile.in
--- build-tree.orig/apache2/server/Makefile.in	2005-02-04 10:40:14.000000000 -0700
+++ build-tree/apache2/server/Makefile.in	2005-02-09 11:25:13.000000000 -0700
@@ -13,7 +13,7 @@
 	util_script.c util_md5.c util_cfgtree.c util_ebcdic.c util_time.c \
 	rfc1413.c connection.c listen.c \
 	mpm_common.c util_charset.c util_debug.c util_xml.c \
-	util_filter.c exports.c buildmark.c \
+	util_filter.c util_pcre.c exports.c buildmark.c \
 	scoreboard.c error_bucket.c protocol.c core.c request.c provider.c \
 	eoc_bucket.c
 
diff -urN build-tree.orig/apache2/server/core.c build-tree/apache2/server/core.c
--- build-tree.orig/apache2/server/core.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/server/core.c	2005-02-09 11:25:13.000000000 -0700
@@ -1618,7 +1618,7 @@
  */
 
 #ifdef WIN32
-#define USE_ICASE REG_ICASE
+#define USE_ICASE AP_REG_ICASE
 #else
 #define USE_ICASE 0
 #endif
@@ -1640,7 +1640,7 @@
     char *old_path = cmd->path;
     core_dir_config *conf;
     ap_conf_vector_t *new_dir_conf = ap_create_per_dir_config(cmd->pool);
-    regex_t *r = NULL;
+    ap_regex_t *r = NULL;
     const command_rec *thiscmd = cmd->cmd;
 
     const char *err = ap_check_cmd_context(cmd,
@@ -1669,13 +1669,13 @@
         cmd->path = ap_getword_conf(cmd->pool, &arg);
         if (!cmd->path)
             return "<Directory ~ > block must specify a path";
-        r = ap_pregcomp(cmd->pool, cmd->path, REG_EXTENDED|USE_ICASE);
+        r = ap_pregcomp(cmd->pool, cmd->path, AP_REG_EXTENDED|USE_ICASE);
         if (!r) {
             return "Regex could not be compiled";
         }
     }
     else if (thiscmd->cmd_data) { /* <DirectoryMatch> */
-        r = ap_pregcomp(cmd->pool, cmd->path, REG_EXTENDED|USE_ICASE);
+        r = ap_pregcomp(cmd->pool, cmd->path, AP_REG_EXTENDED|USE_ICASE);
         if (!r) {
             return "Regex could not be compiled";
         }
@@ -1740,7 +1740,7 @@
     int old_overrides = cmd->override;
     char *old_path = cmd->path;
     core_dir_config *conf;
-    regex_t *r = NULL;
+    ap_regex_t *r = NULL;
     const command_rec *thiscmd = cmd->cmd;
     ap_conf_vector_t *new_url_conf = ap_create_per_dir_config(cmd->pool);
     const char *err = ap_check_cmd_context(cmd,
@@ -1759,14 +1759,14 @@
     cmd->override = OR_ALL|ACCESS_CONF;
 
     if (thiscmd->cmd_data) { /* <LocationMatch> */
-        r = ap_pregcomp(cmd->pool, cmd->path, REG_EXTENDED);
+        r = ap_pregcomp(cmd->pool, cmd->path, AP_REG_EXTENDED);
         if (!r) {
             return "Regex could not be compiled";
         }
     }
     else if (!strcmp(cmd->path, "~")) {
         cmd->path = ap_getword_conf(cmd->pool, &arg);
-        r = ap_pregcomp(cmd->pool, cmd->path, REG_EXTENDED);
+        r = ap_pregcomp(cmd->pool, cmd->path, AP_REG_EXTENDED);
         if (!r) {
             return "Regex could not be compiled";
         }
@@ -1804,7 +1804,7 @@
     int old_overrides = cmd->override;
     char *old_path = cmd->path;
     core_dir_config *conf;
-    regex_t *r = NULL;
+    ap_regex_t *r = NULL;
     const command_rec *thiscmd = cmd->cmd;
     core_dir_config *c = mconfig;
     ap_conf_vector_t *new_file_conf = ap_create_per_dir_config(cmd->pool);
@@ -1827,14 +1827,14 @@
     }
 
     if (thiscmd->cmd_data) { /* <FilesMatch> */
-        r = ap_pregcomp(cmd->pool, cmd->path, REG_EXTENDED|USE_ICASE);
+        r = ap_pregcomp(cmd->pool, cmd->path, AP_REG_EXTENDED|USE_ICASE);
         if (!r) {
             return "Regex could not be compiled";
         }
     }
     else if (!strcmp(cmd->path, "~")) {
         cmd->path = ap_getword_conf(cmd->pool, &arg);
-        r = ap_pregcomp(cmd->pool, cmd->path, REG_EXTENDED|USE_ICASE);
+        r = ap_pregcomp(cmd->pool, cmd->path, AP_REG_EXTENDED|USE_ICASE);
         if (!r) {
             return "Regex could not be compiled";
         }
diff -urN build-tree.orig/apache2/server/request.c build-tree/apache2/server/request.c
--- build-tree.orig/apache2/server/request.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/server/request.c	2005-02-09 11:25:13.000000000 -0700
@@ -1040,7 +1040,7 @@
                 continue;
             }
 
-            if (ap_regexec(entry_core->r, r->filename, 0, NULL, REG_NOTEOL)) {
+            if (ap_regexec(entry_core->r, r->filename, 0, NULL, AP_REG_NOTEOL)) {
                 continue;
             }
 
diff -urN build-tree.orig/apache2/server/util.c build-tree/apache2/server/util.c
--- build-tree.orig/apache2/server/util.c	2005-02-04 13:21:18.000000000 -0700
+++ build-tree/apache2/server/util.c	2005-02-09 11:25:13.000000000 -0700
@@ -256,16 +256,16 @@
 
 static apr_status_t regex_cleanup(void *preg)
 {
-    regfree((regex_t *) preg);
+    ap_regfree((ap_regex_t *) preg);
     return APR_SUCCESS;
 }
 
-AP_DECLARE(regex_t *) ap_pregcomp(apr_pool_t *p, const char *pattern,
+AP_DECLARE(ap_regex_t *) ap_pregcomp(apr_pool_t *p, const char *pattern,
                                    int cflags)
 {
-    regex_t *preg = apr_palloc(p, sizeof(regex_t));
+    ap_regex_t *preg = apr_palloc(p, sizeof *preg);
 
-    if (regcomp(preg, pattern, cflags)) {
+    if (ap_regcomp(preg, pattern, cflags)) {
         return NULL;
     }
 
@@ -275,9 +275,9 @@
     return preg;
 }
 
-AP_DECLARE(void) ap_pregfree(apr_pool_t *p, regex_t * reg)
+AP_DECLARE(void) ap_pregfree(apr_pool_t *p, ap_regex_t * reg)
 {
-    regfree(reg);
+    ap_regfree(reg);
     apr_pool_cleanup_kill(p, (void *) reg, regex_cleanup);
 }
 
@@ -344,25 +344,6 @@
     return bigstring;
 }
 
-/* 
- * Apache stub function for the regex libraries regexec() to make sure the
- * whole regex(3) API is available through the Apache (exported) namespace.
- * This is especially important for the DSO situations of modules.
- * DO NOT MAKE A MACRO OUT OF THIS FUNCTION!
- */
-AP_DECLARE(int) ap_regexec(regex_t *preg, const char *string,
-                           size_t nmatch, regmatch_t pmatch[], int eflags)
-{
-    return regexec(preg, string, nmatch, pmatch, eflags);
-}
-
-AP_DECLARE(size_t) ap_regerror(int errcode, const regex_t *preg, char *errbuf,
-                               size_t errbuf_size)
-{
-    return regerror(errcode, preg, errbuf, errbuf_size);
-}
-
-
 /* This function substitutes for $0-$9, filling in regular expression
  * submatches. Pass it the same nmatch and pmatch arguments that you
  * passed ap_regexec(). pmatch should not be greater than the maximum number
@@ -379,7 +360,7 @@
 
 AP_DECLARE(char *) ap_pregsub(apr_pool_t *p, const char *input,
                               const char *source, size_t nmatch,
-                              regmatch_t pmatch[])
+                              ap_regmatch_t pmatch[])
 {
     const char *src = input;
     char *dest, *dst;
diff -urN build-tree.orig/apache2/server/util_pcre.c build-tree/apache2/server/util_pcre.c
--- build-tree.orig/apache2/server/util_pcre.c	1969-12-31 17:00:00.000000000 -0700
+++ build-tree/apache2/server/util_pcre.c	2005-02-09 11:25:13.000000000 -0700
@@ -0,0 +1,220 @@
+/*************************************************
+*      Perl-Compatible Regular Expressions       *
+*************************************************/
+
+/*
+This is a library of functions to support regular expressions whose syntax
+and semantics are as close as possible to those of the Perl 5 language. See
+the file Tech.Notes for some information on the internals.
+
+This module is a wrapper that provides a POSIX API to the underlying PCRE
+functions.
+
+Written by: Philip Hazel <ph10@cam.ac.uk>
+
+           Copyright (c) 1997-2001 University of Cambridge
+
+-----------------------------------------------------------------------------
+Permission is granted to anyone to use this software for any purpose on any
+computer system, and to redistribute it freely, subject to the following
+restrictions:
+
+1. This software is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+
+2. The origin of this software must not be misrepresented, either by
+   explicit claim or by omission.
+
+3. Altered versions must be plainly marked as such, and must not be
+   misrepresented as being the original software.
+
+4. If PCRE is embedded in any software that is released under the GNU
+   General Purpose Licence (GPL), then the terms of that licence shall
+   supersede any condition above with which it is incompatible.
+-----------------------------------------------------------------------------
+*/
+
+#include <stdlib.h>
+
+#include "ap_regex.h"
+#include "pcre.h"
+ 
+#ifndef POSIX_MALLOC_THRESHOLD
+#define POSIX_MALLOC_THRESHOLD (10)
+#endif
+
+/* Table of error strings corresponding to POSIX error codes; must be
+ * kept in synch with include/ap_regex.h's AP_REG_E* definitions. */
+
+static const char *const pstring[] = {
+  "",                                /* Dummy for value 0 */
+  "internal error",                  /* AP_REG_ASSERT */
+  "failed to get memory",            /* AP_REG_ESPACE */
+  "bad argument",                    /* AP_REG_INVARG */
+  "match failed"                     /* AP_REG_NOMATCH */
+};
+
+AP_DECLARE(size_t) ap_regerror(int errcode, const ap_regex_t *preg, 
+                               char *errbuf, size_t errbuf_size)
+{
+const char *message, *addmessage;
+size_t length, addlength;
+
+message = (errcode >= (int)(sizeof(pstring)/sizeof(char *)))?
+  "unknown error code" : pstring[errcode];
+length = strlen(message) + 1;
+
+addmessage = " at offset ";
+addlength = (preg != NULL && (int)preg->re_erroffset != -1)?
+  strlen(addmessage) + 6 : 0;
+
+if (errbuf_size > 0)
+  {
+  if (addlength > 0 && errbuf_size >= length + addlength)
+    sprintf(errbuf, "%s%s%-6d", message, addmessage, (int)preg->re_erroffset);
+  else
+    {
+    strncpy(errbuf, message, errbuf_size - 1);
+    errbuf[errbuf_size-1] = 0;
+    }
+  }
+
+return length + addlength;
+}
+
+
+
+
+/*************************************************
+*           Free store held by a regex           *
+*************************************************/
+
+AP_DECLARE(void) ap_regfree(ap_regex_t *preg)
+{
+(pcre_free)(preg->re_pcre);
+}
+
+
+
+
+/*************************************************
+*            Compile a regular expression        *
+*************************************************/
+
+/*
+Arguments:
+  preg        points to a structure for recording the compiled expression
+  pattern     the pattern to compile
+  cflags      compilation flags
+
+Returns:      0 on success
+              various non-zero codes on failure
+*/
+
+AP_DECLARE(int) ap_regcomp(ap_regex_t *preg, const char *pattern, int cflags)
+{
+const char *errorptr;
+int erroffset;
+int options = 0;
+
+if ((cflags & AP_REG_ICASE) != 0) options |= PCRE_CASELESS;
+if ((cflags & AP_REG_NEWLINE) != 0) options |= PCRE_MULTILINE;
+
+preg->re_pcre = pcre_compile(pattern, options, &errorptr, &erroffset, NULL);
+preg->re_erroffset = erroffset;
+
+if (preg->re_pcre == NULL) return AP_REG_INVARG;
+
+preg->re_nsub = pcre_info(preg->re_pcre, NULL, NULL);
+return 0;
+}
+
+
+
+
+/*************************************************
+*              Match a regular expression        *
+*************************************************/
+
+/* Unfortunately, PCRE requires 3 ints of working space for each captured
+substring, so we have to get and release working store instead of just using
+the POSIX structures as was done in earlier releases when PCRE needed only 2
+ints. */
+
+#define SMALL_NMATCH 5
+AP_DECLARE(int) ap_regexec(const ap_regex_t *preg, const char *string, size_t nmatch,
+                           ap_regmatch_t pmatch[], int eflags)
+{
+int rc;
+int options = 0;
+/* NOTE: The code related to the "SMALL_NMATCH" optimization
+ * currently is unique to the httpd-2.0 copy of PCRE 3.9.  I've
+ * submitted the patch to the PCRE maintainer for inclusion in
+ * the next PCRE release, slated for late 2002.  At that time,
+ * we can merge the new PCRE version into the httpd-2.0/srclib
+ * tree.  --brianp 3/20/2002
+ */
+int small_ovector[SMALL_NMATCH * 3];
+int *ovector = NULL;
+int allocated_ovector = 0;
+
+if ((eflags & AP_REG_NOTBOL) != 0) options |= PCRE_NOTBOL;
+if ((eflags & AP_REG_NOTEOL) != 0) options |= PCRE_NOTEOL;
+
+#if 0
+/* This causes a memory segfault after locking the const, thread-shared *preg 
+ * generated at compile time, and is entirely unnecessary.
+ */
+((ap_regex_t *)preg->re_erroffset = (size_t)(-1);   /* Only has meaning after compile */
+#endif
+
+if (nmatch > 0)
+  {
+    if (nmatch <= SMALL_NMATCH)
+      {
+      ovector = &(small_ovector[0]);
+      }
+    else
+      {
+      ovector = (int *)malloc(sizeof(int) * nmatch * 3);
+      if (ovector == NULL) return AP_REG_ESPACE;
+      allocated_ovector = 1;
+      }
+  }
+
+rc = pcre_exec(preg->re_pcre, NULL, string, (int)strlen(string), 0, options,
+  ovector, nmatch * 3);
+
+if (rc == 0) rc = nmatch;    /* All captured slots were filled in */
+
+if (rc >= 0)
+  {
+  size_t i;
+  for (i = 0; i < (size_t) rc; i++)
+    {
+    pmatch[i].rm_so = ovector[i*2];
+    pmatch[i].rm_eo = ovector[i*2+1];
+    }
+  if (allocated_ovector) free(ovector);
+  for (; i < nmatch; i++) pmatch[i].rm_so = pmatch[i].rm_eo = -1;
+  return 0;
+  }
+
+else
+  {
+  if (allocated_ovector) free(ovector);
+  switch(rc)
+    {
+    case PCRE_ERROR_NOMATCH: return AP_REG_NOMATCH;
+    case PCRE_ERROR_NULL: return AP_REG_INVARG;
+    case PCRE_ERROR_BADOPTION: return AP_REG_INVARG;
+    case PCRE_ERROR_BADMAGIC: return AP_REG_INVARG;
+    case PCRE_ERROR_UNKNOWN_NODE: return AP_REG_ASSERT;
+    case PCRE_ERROR_NOMEMORY: return AP_REG_ESPACE;
+    default: return AP_REG_ASSERT;
+    }
+  }
+}
+
+/* End of pcreposix.c */
diff -urN build-tree.orig/apache2/srclib/pcre/Makefile.in build-tree/apache2/srclib/pcre/Makefile.in
--- build-tree.orig/apache2/srclib/pcre/Makefile.in	2004-11-24 12:31:09.000000000 -0700
+++ build-tree/apache2/srclib/pcre/Makefile.in	2005-02-09 11:25:13.000000000 -0700
@@ -1,5 +1,5 @@
 LTLIBRARY_NAME = libpcre.la
-LTLIBRARY_SOURCES = maketables.c get.c study.c pcre.c pcreposix.c
+LTLIBRARY_SOURCES = maketables.c get.c study.c pcre.c
 
 CLEAN_TARGETS = dftables chartables.c
 DISTCLEAN_TARGETS = pcre.h pcre-config config.h config.log config.status $(CLEAN_TARGETS)
