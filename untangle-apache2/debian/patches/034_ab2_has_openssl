--- build-tree/apache2/support/ab.c	28 Aug 2004 16:20:08 -0000	1.121.2.12
+++ build-tree/apache2/support/ab.c	28 Sep 2004 16:02:31 -0000
@@ -142,9 +142,17 @@
 #endif
 #if APR_HAVE_STDLIB_H
 #include <stdlib.h>
+#endif
+#if APR_HAVE_UNISTD_H
+#include <unistd.h>
+#endif
+
+#if !defined(WIN32) && !defined(NETWARE)
+#include "ap_config_auto.h"
+#endif
 
-#ifdef	USE_SSL
-#if ((!(RSAREF)) && (!(SYSSSL)))
+#define HAVE_OPENSSL
+#if defined(HAVE_OPENSSL)
 /* Libraries on most systems.. */
 #include <openssl/rsa.h>
 #include <openssl/crypto.h>
@@ -153,20 +161,11 @@
 #include <openssl/err.h>
 #include <openssl/ssl.h>
 #include <openssl/rand.h>
-#else
-/* Libraries for RSAref and SYSSSL */
-#include <rsa.h>
-#include <crypto.h>
-#include <x509.h>
-#include <pem.h>
-#include <err.h>
-#include <ssl.h>
-#include <rand.h>
-#endif
+#define USE_SSL
+
 #endif
 
 #include <math.h>
-#endif
 #if APR_HAVE_CTYPE_H
 #include <ctype.h>
 #endif
@@ -424,7 +423,7 @@
  *
  */
 #ifdef USE_SSL
-long ssl_print_cb(BIO *bio,int cmd,const char *argp,int argi,long argl,long ret)
+static long ssl_print_cb(BIO *bio,int cmd,const char *argp,int argi,long argl,long ret)
 {
     BIO *out;
 
@@ -466,7 +465,7 @@
     return i;
 }
 
-void ssl_rand_seed()
+static void ssl_rand_seed()
 {
     int nDone = 0;
     int n, l;
@@ -498,9 +497,7 @@
     nDone += 128;
 }
 
-int ssl_print_connection_info(bio,ssl)
-BIO *bio;
-SSL *ssl;
+static int ssl_print_connection_info(BIO *bio, SSL *ssl)
 {
         SSL_CIPHER *c;
         int alg_bits,bits;
@@ -515,9 +512,7 @@
         return(1);
 }
 
-int ssl_print_cert_info(bio,x509cert)
-BIO *bio;
-X509 *x509cert;
+static int ssl_print_cert_info(BIO *bio, X509 *x509cert)
 {
         X509_NAME *dn;
         char buf[64];
@@ -549,7 +544,7 @@
         return(1);
 }
 
-void ssl_start_connect(struct connection * c)
+static void ssl_start_connect(struct connection * c)
 {
     BIO *bio;
     X509 *x509cert;
@@ -685,7 +680,7 @@
     do {
 	apr_time_t tnow = apr_time_now();
 	apr_size_t l = c->rwrite;
-	apr_status_t e;
+	apr_status_t e = APR_SUCCESS; /* prevent GCC warning */
 
 	/*
 	 * First time round ?
@@ -1670,7 +1665,14 @@
 
 	for (i = 0; i < n; i++) {
             const apr_pollfd_t *next_fd = &(pollresults[i]);
-            struct connection *c = next_fd->client_data;
+            struct connection *c;
+
+#ifdef USE_SSL
+            if (ssl)
+                c = &con[i];
+            else
+#endif
+                c = next_fd->client_data;
 
 	    /*
 	     * If the connection isn't connected how can we check it?
@@ -1772,14 +1774,14 @@
 static void copyright(void)
 {
     if (!use_html) {
-	printf("This is ApacheBench, Version %s\n", AP_AB_BASEREVISION " <$Revision: 1.121.2.12 $> apache-2.0");
+	printf("This is ApacheBench, Version %s\n", AP_AB_BASEREVISION " <$Revision: 1.141 $> apache-2.0");
 	printf("Copyright (c) 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\n");
 	printf("Copyright (c) 1998-2002 The Apache Software Foundation, http://www.apache.org/\n");
 	printf("\n");
     }
     else {
 	printf("<p>\n");
-	printf(" This is ApacheBench, Version %s <i>&lt;%s&gt;</i> apache-2.0<br>\n", AP_AB_BASEREVISION, "$Revision: 1.121.2.12 $");
+	printf(" This is ApacheBench, Version %s <i>&lt;%s&gt;</i> apache-2.0<br>\n", AP_AB_BASEREVISION, "$Revision: 1.141 $");
 	printf(" Copyright (c) 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/<br>\n");
 	printf(" Copyright (c) 1998-2002 The Apache Software Foundation, http://www.apache.org/<br>\n");
 	printf("</p>\n<p>\n");
