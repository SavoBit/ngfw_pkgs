#! /bin/bash

set -e

usage() {
  echo "$0 -f <output-file> [-r <repository>] [-a <arch>]"
  exit 1
}

if [ $(id -u) != 0 ] ; then
  exec sudo -E $0 $*
fi

### CLI args
while getopts f:r:a: option ; do
  case "$option" in
    r) REPOSITORY="$OPTARG" ;;
    f) IMAGE="$OPTARG" ;;
    a) ARCH="$OPTARG" ;;
    h) usage ;;
    \?) usage ;;
  esac
done

## main
[[ -z "$IMAGE" ]] && usage
if [[ -e $IMAGE ]] ; then
  echo "$IMAGE already exists, please remove it manually"
  exit 1
fi

[[ -z "$ARCH" ]] && ARCH="amd64"
[[ -z "$REPOSITORY" ]] && REPOSITORY="stretch"

CUSTOM_DIR=$(readlink -f $(dirname $0))/vmdebootstrap

vmdebootstrap --arch $ARCH \
              --distribution $REPOSITORY \
	      --mirror http://deb.debian.org/debian \
	      --image $IMAGE \
	      --size 5G \
	      --verbose \
	      --root-password passwd \
	      --hostname client-${REPOSITORY}-${ARCH} \
	      --sparse \
	      --grub \
	      --package curl \
	      --customize no-systemd-emergency-target.sh
