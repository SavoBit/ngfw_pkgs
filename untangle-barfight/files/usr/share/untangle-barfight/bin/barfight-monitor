#!/bin/dash

mkdir -p /var/log/barfight

exec >> /var/log/barfight/monitor.log 2>&1

NAME="untangle-barfight"
BARFIGHT_PID_FILE="/var/run/${NAME}.pid"

BARFIGHT_MONITOR_DELAY="10"

load_defaults()
{
    BARFIGHT_BIND_PORT="3001"
    BARFIGHT_QUEUE_NUM="3001"
    
    BARFIGHT_CONF_FILE="/var/lib/barfight.conf"
    
    BARFIGHT_MONITOR_DELAY="10"

    BARFIGHT_LOG_OUT="/var/log/barfight/debug.log"
    BARFIGHT_LOG_ERR="/var/log/barfight/error.log"
    
    if [ -f /etc/default/untangle-barfight ] ; then
        . /etc/default/untangle-barfight
    fi
}

flush_iptables()
{
    /etc/init.d/untangle-net-alpaca-iptables restart
}

reap_child()
{
    echo "[`date`] Retrieved signal to stop daemon."

    ## this is ... special
    for t in `seq 1 10` ; do 
        pidof ${NAME} || break

        killall ${NAME}
        sleep 1
    done
    
    sleep 1
    flush_iptables
    exit 0
}

start_barfight()
{
    killall ${NAME} > /dev/null 2>&1

    load_defaults

    local t_args="-d "
    
    test -n "${BARFIGHT_BIND_PORT}" && t_args="${t_args} -p ${BARFIGHT_BIND_PORT}"
    test -n "${BARFIGHT_QUEUE_NUM}" && t_args="${t_args} -q ${BARFIGHT_QUEUE_NUM}"
    test -n "${BARFIGHT_CONF_FILE}" && t_args="${t_args} -c ${BARFIGHT_CONF_FILE}"
    test -n "${BARFIGHT_LOG_OUT}" && t_args="${t_args} -o ${BARFIGHT_LOG_OUT}"
    test -n "${BARFIGHT_LOG_ERR}" && t_args="${t_args} -e ${BARFIGHT_LOG_ERR}"
    
    /usr/bin/${NAME} ${t_args}
    
    ## Give it some time to grab the queue so iptables knows that it is still running
    sleep 1
    flush_iptables
}

is_still_running()
{
    local t_pid="invalid"
    
    ## First just validate that the queue is bound
    if [ ! -f /proc/net/netfilter/nfnetlink_queue ] ; then return 1 ; fi

    local t_queue_pid=`awk -v queue=${BARFIGHT_QUEUE_NUM} '{ if ( $1 == queue ) print $2 }' /proc/net/netfilter/nfnetlink_queue`
    if [ -z "${t_queue_pid}" ]; then return 1 ; fi

    ## Perform a simple curl call to make sure the server is still running.
    curl -sf -F 'json_request=@-' -m 10 "http://localhost:${BARFIGHT_BIND_PORT}"  > /dev/null 2>&1 <<EOF
{ "function" : "hello_world" }
EOF
}

trap reap_child 6
trap reap_child 15
trap reap_child 2

while ( true ) ;  do
    is_still_running || {
        echo "[`date`] Barfight stopped, restarting daemon"
        start_barfight
    } && {
        echo "[`date`] barfight is still running."
    }

    sleep ${BARFIGHT_MONITOR_DELAY}
done
